# 07-配置管理

## 配置系统

```
1. 默认配置 (代码defaults)
2. 用户配置 (~/.openclaw/openclaw.json)
3. 环境变量
4. CLI参数
5. 运行时合并
```

## 配置结构

```typescript
// src/config/config.ts
interface OpenClawConfig {
  // Agent配置
  agent?: AgentConfig;

  // Gateway配置
  gateway?: GatewayConfig;

  // Channels配置
  channels?: ChannelsConfig;

  // 浏览器配置
  browser?: BrowserConfig;

  // Canvas配置
  canvas?: CanvasConfig;

  // Node配置
  nodes?: NodesConfig;

  // 插件配置
  plugins?: PluginsConfig;
}
```

## 加载流程

```typescript
// src/config/loader.ts
async function loadConfig(): Promise<OpenClawConfig> {
  // 1. 从文件加载
  const fileConfig = await loadFromFile();
  
  // 2. 应用环境变量
  const envConfig = loadFromEnv();
  
  // 3. 应用CLI参数
  const cliConfig = loadFromArgs();
  
  // 4. 合并配置
  const merged = mergeConfig(defaults, fileConfig, envConfig, cliConfig);
  
  // 5. 验证
  const validated = await validateConfig(merged);
  if (!validated.valid) {
    throw new ConfigValidationError(validated.errors);
  }
  
  // 6. 返回
  return merged;
}

// 合并顺序(优先级从低到高)
function mergeConfig(...configs: Partial<OpenClawConfig>[]): OpenClawConfig {
  return configs.reduce((acc, config) => ({
    ...acc,
    ...config
  }, {} as OpenClawConfig);
}
```

## 配置验证

```typescript
// src/config/validator.ts
interface ValidationResult {
  valid: boolean;
  errors: string[];
  warnings: string[];
}

function validateConfig(config: OpenClawConfig): ValidationResult {
  const errors: string[] = [];
  const warnings: string[] = [];

  // 1. 必需字段检查
  if (!config.agent?.model) {
    errors.push('agent.model is required');
  }

  // 2. 类型检查
  if (config.gateway?.bind && !isValidBind(config.gateway.bind)) {
    errors.push('gateway.bind must be a valid binding address');
  }

  // 3. 渠道配置检查
  for (const [channel, config] of Object.entries(config.channels || {})) {
    const channelErrors = validateChannelConfig(channel, config);
    errors.push(...channelErrors);
  }

  // 4. 安全警告
  if (config.agents?.defaults?.sandbox?.mode === 'non-main') {
    warnings.push('Sandbox mode enabled for non-main sessions');
  }

  return {
    valid: errors.length === 0,
    errors,
    warnings
  };
}
```

## 热重载

```typescript
// src/config/hot-reload.ts
function setupHotReload(): void {
  const configPath = getConfigPath();
  const watcher = fs.watch(configPath, (event, filename) => {
    if (filename !== path.basename(configPath)) return;

    try {
      const newConfig = JSON.parse(fs.readFileSync(configPath, 'utf-8'));
      const validated = validateConfig(newConfig);
      
      if (validated.valid) {
        // 热重载配置
        applyConfig(newConfig);
        notifyReload();
      } else {
        logger.error('Invalid config after reload:', validated.errors);
      }
    } catch (error) {
      logger.error('Failed to reload config:', error);
    }
  });
}
```

## 配置存储

### 文件位置

```
~/.openclaw/
├── openclaw.json          # 主配置文件
├── agents/
│   ├── agents.json
│   └── workspace/
├── credentials/           # 凭证存储
├── plugins/
│   ├── msteams.json
│   └── matrix.json
└── sessions/              # 会话数据
```

### 加载函数

```typescript
// src/config/storage.ts
function getConfigPath(): string {
  return path.join(
    os.homedir(),
    '.openclaw',
    'openclaw.json'
  );
}

function loadFromFile(): Promise<OpenClawConfig> {
  const configPath = getConfigPath();
  const content = await fs.readFile(configPath, 'utf-8');
  return JSON.parse(content);
}

async function saveToFile(config: OpenClawConfig): Promise<void> {
  const configPath = getConfigPath();
  const content = JSON.stringify(config, null, 2);
  await fs.writeFile(configPath, content, 'utf-8');
}
```

## 环境变量

```typescript
// src/config/env.ts
interface EnvMapping {
  configKey: string;
  envVar: string;
  transform?: (value: string) => any;
}

const envMappings: EnvMapping[] = [
  { configKey: 'agent.model', envVar: 'OPENCLAW_MODEL' },
  { configKey: 'gateway.bind', envVar: 'OPENCLAW_BIND' },
  { configKey: 'channels.telegram.botToken', envVar: 'TELEGRAM_BOT_TOKEN' },
  { configKey: 'channels.whatsapp.allowFrom', envVar: 'OPENCLAW_WHATSAPP_ALLOW_FROM' },
  { configKey: 'discord.token', envVar: 'DISCORD_BOT_TOKEN' },
  { configKey: 'slack.botToken', envVar: 'SLACK_BOT_TOKEN' },
  { configKey: 'slack.appToken', envVar: 'SLACK_APP_TOKEN' },
];

function loadFromEnv(): Partial<OpenClawConfig> {
  const envConfig: Partial<OpenClawConfig> = {};

  for (const mapping of envMappings) {
    const value = process.env[mapping.envVar];
    if (value !== undefined) {
      const configKey = mapping.configKey.split('.');
      setNestedValue(envConfig, configKey, value);
    }
  }

  return envConfig;
}

function setNestedValue(obj: any, key: string, value: any): void {
  const keys = key.split('.');
  const lastKey = keys.pop();
  let current = obj;
  
  for (const k of keys) {
    current = current[k];
  }
  
  current[lastKey] = value;
}
```

## CLI参数

```typescript
// src/config/cli-args.ts
const cliArgs = parseArgs(process.argv.slice(2));

interface ParsedArgs {
  config?: string;
  profile?: string;
  command?: string;
  remaining: string[];
}

function parseArgs(args: string[]): ParsedArgs {
  const parsed: ParsedArgs = {};

  let i = 0;
  while (i < args.length) {
    const arg = args[i];

    if (arg.startsWith('--config=')) {
      parsed.config = arg.split('=')[1];
    } else if (arg.startsWith('--profile=')) {
      parsed.profile = arg.split('=')[1];
    } else if (arg === '--no-color') {
      // 处理无颜色标志
    } else {
      parsed.remaining.push(arg);
    }

    i++;
  }

  return parsed;
}
```

## 配置更新

```typescript
// src/config/updater.ts
class ConfigUpdater {
  private currentConfig: OpenClawConfig;

  update(updates: Partial<OpenClawConfig>): void {
    // 1. 更新本地配置
    const newConfig = { ...this.currentConfig, ...updates };
    saveToFile(newConfig);

    // 2. 更新运行时配置
    this.currentConfig = newConfig;

    // 3. 通知监听器
    notifyConfigChanged(newConfig);
  }

  get(): OpenClawConfig {
    return this.currentConfig;
  }
}

const configUpdater = new ConfigUpdater();
```

## 默认配置

```typescript
// src/config/defaults.ts
const defaults: OpenClawConfig = {
  agent: {
    model: 'anthropic/claude-opus-4-6',
    maxTokens: 200000,
    temperature: 1.0,
    thinkingLevel: 'medium'
  },
  gateway: {
    bind: 'loopback',
    port: 18789,
    auth: {
      mode: 'token',
      requireAuth: true
    }
  },
  channels: {
    dmPolicy: 'pairing'
  },
  browser: {
    enabled: false
  },
  canvas: {
    enabled: true
  },
  nodes: {
    enabled: true
  },
  agents: {
    defaults: {
      sandbox: {
        mode: 'non-main',
        allowlist: ['bash', 'read', 'write'],
        denylist: ['browser', 'canvas']
      }
    }
  }
};
```

## 学习重点

1. **配置加载**: 理解多源配置合并
2. **验证机制**: 学习配置验证和错误处理
3. **热重载**: 理解配置变更监听
4. **环境变量**: 掌握环境变量映射
5. **配置存储**: 理解文件结构和位置

## 相关文件

- [src/config/config.ts](../../src/config/config.ts)
- [src/config/loader.ts](../../src/config/loader.ts)
- [src/config/validator.ts](../../src/config/validator.ts)
- [src/config/storage.ts](../../src/config/storage.ts)

## 下一步

- [08-工具系统.md](./08-工具系统.md) - Tools实现
- [09-会话管理.md](./09-会话管理.md) - Session模型

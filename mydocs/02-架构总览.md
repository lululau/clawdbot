# 02-OpenClaw架构总览

## 目录
- [架构图](#架构图)
- [核心组件](#核心组件)
- [数据流](#数据流)
- [通信协议](#通信协议)
- [安全模型](#安全模型)
- [扩展机制](#扩展机制)

## 架构图

### 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                      用户交互层                               │
│  ┌──────────┬──────────┬──────────┬──────────┬───────────┐  │
│  │WhatsApp  │ Telegram  │  Slack   │ Discord  │   ...    │  │
│  └────┬─────┴────┬─────┴────┬─────┴────┬─────┘  │
└───────┼───────────┼───────────┼───────────┼─────────────┘
        │           │           │           │
        ▼           ▼           ▼           ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Channels 层                              │
│  ┌──────────┬──────────┬──────────┬──────────────────┐      │
│  │WhatsApp  │ Telegram  │  Slack   │      ...        │      │
│  └────┬─────┴────┬─────┴────┬─────┴───────────┘      │
└───────┼───────────┼───────────┼───────────────────────┘
        │           │           │
        ▼           ▼           ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Gateway 层                               │
│  ┌──────────────────────────────────────────────────────┐      │
│  │  WebSocket Server (ws://127.0.0.1:18789)     │      │
│  │  ┌────────────────────────────────────────────┐     │      │
│  │  │  Session Manager (会话管理)          │     │      │
│  │  │  ┌──────────────────────────────────┐    │     │      │
│  │  │  │  Agent Runtime (Pi代理)    │    │     │      │
│  │  │  │  - 工具调用               │    │     │      │
│  │  │  │  - 流式响应               │    │     │
│  │  │  │  - 上下文管理             │    │     │      │
│  │  │  └──────────────────────────────────┘    │     │      │
│  │  │  Plugin Manager (插件系统)      │     │      │
│  │  │  Tool Registry (工具注册)      │     │      │
│  │  │  Config Manager (配置管理)      │     │      │
│  │  │  Event Bus (事件总线)          │     │      │
│  │  └────────────────────────────────────┘     │      │
│  └──────────────────────────────────────────────┘      │
└───────┼────────────┬─────────────────┬────────────────┘
        │            │                 │
        ▼            ▼                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                      客户层                                 │
│  ┌──────────┬──────────┬──────────┬───────────────────┐      │
│  │   CLI    │  Web UI  │macOS App │    Nodes          │      │
│  │  openclaw │  Control │  Menu    │  iOS/Android     │      │
│  │  command  │  Panel   │  Bar     │                  │      │
│  └────┬─────┴────┬─────┴────┬─────┴─────────────────┘      │
└───────┼───────────┼───────────┼───────────────────────┘
        ▼            ▼           ▼
┌─────────────────────────────────────────────────────────────────┐
│                    基础设施层                                 │
│  ┌──────────────────────────────────────────────────────┐      │
│  │  Config Storage (~/.openclaw/)            │      │
│  │  Session Storage (会话数据)               │      │
│  │  Credentials (凭证存储)                  │      │
│  │  Workspace (工作区)                     │      │
│  │  Plugins/Skills (插件/技能)             │      │
│  └──────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────┘
```

### 分层架构

OpenClaw采用清晰的分层架构设计:

```
┌─────────────────────────────────────────────────┐
│              表现层(Presentation)              │
│         Channels, CLI, Web UI, Apps         │
└────────────────┬────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────┐
│              控制层(Control)                 │
│      Gateway (WebSocket Server)              │
│      Session Management                     │
│      Plugin System                         │
└────────────────┬────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────┐
│              逻辑层(Logic)                   │
│      Agent Runtime (Pi)                    │
│      Tool Execution                         │
│      Event Handling                        │
└────────────────┬────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────┐
│              数据层(Data)                     │
│      Config Storage                        │
│      Session Storage                       │
│      Credentials                          │
└─────────────────────────────────────────────────┘
```

## 核心组件

### 1. Gateway Server

**位置**: `src/gateway/`

**职责**:
- WebSocket服务器,提供统一API
- 请求路由和方法分发
- 会话生命周期管理
- 客户端认证和授权

**关键文件**:
```
src/gateway/
├── server.impl.ts           # Gateway实现
├── server.ts              # 服务器入口
├── server-http.ts         # HTTP端点
├── server-channels.ts     # 渠道处理
├── server-chat.ts        # 聊天处理
├── server-node-events.ts # 节点事件
├── server-methods/       # WebSocket方法
├── auth.ts               # 认证逻辑
└── client.ts             # 客户端管理
```

**核心功能**:
```typescript
// WebSocket方法路由
{
  // 客户端方法
  "gateway.startup",
  "chat.send",
  "agent.invoke",
  "sessions.list",
  "sessions.patch",
  "sessions.send",
  "sessions.spawn",
  "tools.invoke",
  "node.list",
  "node.invoke",

  // 服务器推送
  "chat.event",
  "agent.event",
  "session.event",
  "tool.event",
  "node.event"
}
```

### 2. Agent Runtime

**位置**: `src/agents/`

**职责**:
- Pi代理集成
- AI模型调用
- 工具执行协调
- 流式响应处理
- 上下文管理

**核心组件**:
```
src/agents/
├── pi-embedded-runner/       # Pi嵌入运行器
├── pi-embedded-subscribe/   # 事件订阅
├── model-selection/         # 模型选择
├── model-auth/             # 模型认证
├── pi-tools/               # Pi工具适配
├── context/                # 上下文管理
├── session-utils/          # 会话工具
└── subagent-registry/       # 子Agent注册
```

**Agent执行流程**:
```
用户消息
  ↓
Session查找/创建
  ↓
上下文加载 (历史、配置)
  ↓
Pi Agent调用
  ↓
├─→ 工具调用序列
├─→ 流式响应处理
└─→ 事件触发
  ↓
响应返回
```

### 3. Channels System

**位置**: `src/channels/`

**职责**:
- 消息平台抽象
- 统一消息格式
- 渠道特定逻辑处理
- 错误处理和重试

**渠道接口**:
```typescript
interface Channel {
  name: string;              // 渠道名称
  send(message: Message): void;
  connect(): Promise<void>;
  disconnect(): void;
  getStatus(): ChannelStatus;
}
```

**支持渠道**:
| 渠道 | 实现库 | 状态 |
|------|---------|------|
| WhatsApp | Baileys | ✅ |
| Telegram | grammY | ✅ |
| Slack | Bolt | ✅ |
| Discord | discord.js | ✅ |
| Google Chat | Chat API | ✅ |
| Signal | signal-cli | ✅ |
| iMessage | BlueBubbles/imsg | ✅ |
| Teams | 扩展 | ✅ |

### 4. Plugin System

**位置**: `src/plugins/` + `extensions/`

**职责**:
- 插件发现和加载
- 插件生命周期管理
- 插件API提供
- 扩展点注册

**插件类型**:
```typescript
interface Plugin {
  name: string;
  version: string;
  type: 'channel' | 'memory' | 'provider';
  activate(): Promise<void>;
  deactivate(): void;
}
```

**扩展点**:
- 渠道扩展 (extensions/*)
- 内存插件
- 提供商插件

### 5. Configuration Management

**位置**: `src/config/`

**职责**:
- 配置加载和验证
- 配置热重载
- 默认值处理
- 环境变量支持

**配置层级**:
```
1. 默认配置 (代码中的defaults)
2. 用户配置 (~/.openclaw/openclaw.json)
3. 环境变量 (process.env)
4. CLI参数 (--config, --profile)
```

### 6. Tool System

**位置**: `src/agents/tools/`

**职责**:
- 工具注册和发现
- 工具权限验证
- 工具执行和结果处理
- 工具超时管理

**内置工具**:
```typescript
{
  // 基础工具
  "bash": CommandExecutionTool,
  "read": FileReaderTool,
  "write": FileWriterTool,
  "edit": FileEditorTool,

  // OpenClaw工具
  "browser": BrowserControlTool,
  "canvas": CanvasTool,
  "nodes": DeviceNodesTool,
  "sessions_list": SessionListTool,
  "sessions_send": SessionSendTool,
  "sessions_spawn": SessionSpawnTool,

  // 渠道工具
  "telegram": TelegramChannelTool,
  "slack": SlackChannelTool,
  "discord": DiscordChannelTool,

  // 系统工具
  "cron": CronTool,
  "gateway": GatewayTool
}
```

## 数据流

### 消息处理流程

```
┌──────────┐
│  用户   │
└─────┬────┘
      │
      ▼
┌─────────────┐
│   Channel   │ ◄─ 平台特定消息
│   (WhatsApp) │
└─────┬───────┘
      │
      ▼
┌─────────────┐
│   Gateway   │ ◄─ 统一消息格式
│ (标准化)    │
└─────┬───────┘
      │
      ▼
┌─────────────┐
│   Session   │ ◄─ 查找/创建会话
│ (查找)      │
└─────┬───────┘
      │
      ▼
┌─────────────┐
│   Agent     │ ◄─ 上下文 + 历史加载
│  (Pi代理)   │
└─────┬───────┘
      │
  ┌───┴─────┐
  ▼         ▼
┌──────┐ ┌──────────┐
│工具调用│ │ 流式响应  │
└──┬───┘ └─────┬─────┘
     │           │
     ▼           ▼
┌───────────────────────────┐
│    结果收集与格式化       │
└─────────┬───────────────┘
          │
          ▼
┌─────────────┐
│  Channel   │ ◄─ 格式化回复
│  (回复)    │
└─────┬───────┘
      │
      ▼
┌──────────┐
│  用户   │
└─────────┘
```

### WebSocket通信流

```typescript
// 客户端 → Gateway
{
  "method": "chat.send",
  "params": {
    "sessionId": "main",
    "message": "Hello, OpenClaw!"
  }
}

// Gateway → 客户端 (流式)
{
  "type": "chat.event",
  "event": "message.delta",
  "data": {
    "sessionId": "main",
    "delta": "Hello"
  }
}

// 客户端 → Gateway (确认)
{
  "method": "chat.ack",
  "params": {
    "sessionId": "main",
    "eventId": "event-123"
  }
}
```

## 通信协议

### WebSocket协议

**协议格式**: JSON-RPC 2.0 变体

**连接端点**: `ws://127.0.0.1:18789`

**认证**:
```typescript
// 1. 握手
{
  "type": "gateway.hello",
  "version": "1.0.0",
  "authToken": "..."  // 可选
}

// 2. 服务器响应
{
  "type": "gateway.welcome",
  "serverId": "...",
  "configHash": "..."
}
```

**方法调用**:
```typescript
// 请求
{
  "id": 1,
  "method": "agent.invoke",
  "params": { ... }
}

// 响应
{
  "id": 1,
  "result": { ... }
}

// 错误
{
  "id": 1,
  "error": {
    "code": -32603,
    "message": "Tool not found"
  }
}
```

### 事件流

Gateway使用事件流推送实时更新:

```typescript
// 事件类型
interface GatewayEvent {
  type: string;
  event: string;
  data: unknown;
  id: string;
  timestamp: number;
}

// 示例
{
  "type": "chat.event",
  "event": "message.delta",
  "data": { "text": "Hello" },
  "id": "evt-abc123",
  "timestamp": 1234567890
}
```

## 安全模型

### 认证与授权

**层级认证**:
```
1. WebSocket认证 (gateway.authToken)
2. HTTP认证 (Bearer token)
3. 节点配对 (pairing codes)
4. 渠道凭证 (channel-specific tokens)
```

**会话隔离**:
- `main`会话: 完全权限,无沙盒
- `group`会话: 受限权限,可选沙盒
- `dm`会话: 需配对机制,默认拒绝未知用户

### 工具权限控制

**权限级别**:
```typescript
enum ToolPermission {
  AlwaysAllowed = "always",     // 总是允许
  MainOnly = "main",           // 仅main会话
  RequiresApproval = "approval", // 需要用户批准
  Blocked = "blocked"           // 被阻止
}
```

**沙盒模式**:
```json5
{
  "agents": {
    "defaults": {
      "sandbox": {
        "mode": "non-main",  // 非main会话使用沙盒
        "allowlist": ["bash", "read", "write"],
        "denylist": ["browser", "canvas"]
      }
    }
  }
}
```

## 扩展机制

### Plugin SDK

**位置**: `src/plugin-sdk/`

**接口定义**:
```typescript
// 渠道插件
export interface ChannelPlugin {
  readonly name: string;
  readonly type: 'channel';

  start(options: ChannelOptions): Promise<ChannelHandle>;
  stop(): Promise<void>;

  send(message: OutboundMessage): Promise<void>;
  getStatus(): ChannelStatus;
}

// 内存插件
export interface MemoryPlugin {
  readonly name: string;
  readonly type: 'memory';

  search(query: string, options?: SearchOptions): Promise<MemoryResult[]>;
  store(entry: MemoryEntry): Promise<void>;
  retrieve(key: string): Promise<MemoryEntry | null>;
}
```

**插件发现**:
```
extensions/
├── msteams/     # Microsoft Teams
├── matrix/       # Matrix
├── zalo/         # Zalo
├── zalouser/     # Zalo Personal
└── ...
```

### Skills Platform

**技能目录结构**:
```
~/.openclaw/workspace/skills/
├── bundled/      # 内置技能
├── managed/      # 管理技能
└── custom/       # 自定义技能
  └── my-skill/
      ├── SKILL.md     # 技能定义
      ├── install.ts    # 安装脚本
      └── manifest.json # 清单
```

**技能格式**:
```markdown
# 技能名称

简短描述技能的作用。

## 使用场景

### 前置条件

- 列出依赖
- 配置要求

### 步骤

1. 第一步...
2. 第二步...

## 工具

### my-tool

工具描述和参数。
```

## 性能考虑

### 流式处理

**分块策略**:
```typescript
// 消息分块
interface ChunkStrategy {
  type: 'paragraph' | 'sentence' | 'token';
  maxSize: number;
  delay: number;  // 毫秒
}

// 流式发送
async function sendStream(
  message: string,
  strategy: ChunkStrategy
): Promise<void> {
  const chunks = chunkMessage(message, strategy);
  for (const chunk of chunks) {
    await channel.send(chunk);
    await delay(strategy.delay);
  }
}
```

### 并发控制

**Agent并发**:
```typescript
// 单个Agent内的工具调用
const maxConcurrentTools = 5;

// 多Agent并发
const maxConcurrentAgents = 3;
const maxConcurrentSessions = 10;
```

## 监控与调试

### 日志系统

**日志级别**:
```typescript
enum LogLevel {
  Debug = 'debug',
  Info = 'info',
  Warn = 'warn',
  Error = 'error'
}
```

**日志位置**:
- Gateway日志: 控制台 + 文件
- Agent日志: 会话日志
- 渠道日志: 平台特定

### 健康检查

```bash
# CLI命令
openclaw doctor

# 检查项
- ✅ Gateway运行状态
- ✅ 配置有效性
- ✅ 凭证状态
- ✅ 渠道连接
- ✅ 权限设置
```

## 下一步

深入学习以下模块:

1. [03-Gateway核心.md](./03-Gateway核心.md) - Gateway实现细节
2. [04-Channels系统.md](./04-Channels系统.md) - 渠道抽象层
3. [05-Agent运行时.md](./05-Agent运行时.md) - Pi代理机制
4. [06-插件系统.md](./06-插件系统.md) - 扩展机制

---

**学习建议**: 理解整体架构后,建议阅读Gateway核心文档,深入了解WebSocket服务器实现。

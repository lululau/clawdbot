# 06-插件系统

## 架构

```
extensions/    plugin-sdk/     src/plugins/
    │              │           ↓
    └── Plugin ←→ Plugin Manager → Gateway
```

## Plugin SDK

**位置**: `src/plugin-sdk/`

### 核心接口

```typescript
// src/plugin-sdk/index.ts
export interface Plugin {
  readonly name: string;
  readonly version: string;
  
  activate(): Promise<void>;
  deactivate(): void;
}

// 渠道插件
export interface ChannelPlugin extends Plugin {
  start(options: ChannelOptions): Promise<Channel>;
  stop(): Promise<void>;
  send(message: OutboundMessage): Promise<void>;
}

// 内存插件
export interface MemoryPlugin extends Plugin {
  search(query: string): Promise<MemoryResult[]>;
  store(entry: MemoryEntry): Promise<void>;
  retrieve(key: string): Promise<MemoryEntry | null>;
}
```

### 插件元数据

```typescript
// package.json (插件)
{
  "name": "my-channel",
  "version": "1.0.0",
  "type": "channel",
  "main": "./dist/index.js",
  "peerDependencies": {
    "openclaw": "workspace:^0.1.0"
  },
  "openclaw": {
    "pluginType": "channel"
  }
}
```

## 插件发现

### 插件加载

```typescript
// src/plugins/plugin-loader.ts
async function loadPlugins(): Promise<Plugin[]> {
  const pluginDirs = [
    'extensions/msteams',
    'extensions/matrix',
    'extensions/zalo',
    'extensions/zalouser'
  ];

  const plugins: Plugin[] = [];
  for (const dir of pluginDirs) {
    try {
      const manifest = await loadManifest(dir);
      const plugin = await importPlugin(dir);
      plugins.push(plugin);
    } catch (error) {
      logger.warn(`Failed to load plugin from ${dir}:`, error);
    }
  }

  return plugins;
}

async function loadManifest(dir: string): Promise<PluginManifest> {
  const manifestPath = path.join(dir, 'package.json');
  const content = await fs.readFile(manifestPath, 'utf-8');
  return JSON.parse(content) as PluginManifest;
}
```

### 插件验证

```typescript
// src/plugins/plugin-validator.ts
interface ValidationResult {
  valid: boolean;
  errors: string[];
}

function validatePlugin(plugin: Plugin): ValidationResult {
  const errors: string[] = [];

  // 1. 检查必需字段
  if (!plugin.name) errors.push('name is required');
  if (!plugin.version) errors.push('version is required');

  // 2. 检查类型兼容性
  const requiredMethods = getRequiredMethods(plugin.type);
  for (const method of requiredMethods) {
    if (typeof (plugin as any)[method] !== 'function') {
      errors.push(`Method ${method} not implemented`);
    }
  }

  return {
    valid: errors.length === 0,
    errors
  };
}
```

## 生命周期

```typescript
// src/plugins/plugin-lifecycle.ts
class PluginManager {
  private plugins = new Map<string, Plugin>();

  async loadAll(): Promise<void> {
    const plugins = await loadPlugins();
    for (const plugin of plugins) {
      await this.activate(plugin);
    }
  }

  async activate(plugin: Plugin): Promise<void> {
    // 1. 验证
    const validation = validatePlugin(plugin);
    if (!validation.valid) {
      throw new PluginValidationError(plugin.name, validation.errors);
    }

    // 2. 激活
    await plugin.activate();
    this.plugins.set(plugin.name, plugin);

    // 3. 通知Gateway
    gateway.notify('plugin.activated', { 
      plugin: plugin.name,
      version: plugin.version 
    });
  }

  deactivate(plugin: Plugin): void {
    const instance = this.plugins.get(plugin.name);
    if (instance) {
      instance.deactivate();
      this.plugins.delete(plugin.name);
      gateway.notify('plugin.deactivated', { plugin: plugin.name });
    }
  }
}
```

## 渠道插件示例

### Microsoft Teams

```typescript
// extensions/msteams/src/index.ts
export class MSTeamsPlugin implements ChannelPlugin {
  readonly name = 'msteams';
  readonly version = '1.0.0';

  async start(options: ChannelOptions): Promise<Channel> {
    // 1. 加载配置
    const config = await loadMSTeamsConfig();
    
    // 2. 创建Bot框架连接
    const botFramework = new BotFrameworkAdapter(config);
    await botFramework.connect();

    // 3. 返回Channel接口
    return {
      name: this.name,
      send: async (message) => await botFramework.sendMessage(message),
      // ...其他Channel方法
    };
  }

  stop(): Promise<void> {
    await botFramework.disconnect();
  }
}
```

## 内存插件

```typescript
// src/plugins/memory/qdrant.ts
export class QdrantPlugin implements MemoryPlugin {
  readonly name = 'qdrant';
  readonly version = '1.0.0';

  async start(): Promise<void> {
    // 初始化Qdrant连接
    this.client = new QdrantClient(config.endpoint);
    await this.client.connect();
  }

  async search(query: string): Promise<MemoryResult[]> {
    return await this.client.search({
      collection: config.collection,
      vector: await embed(query),
      limit: 5
    });
  }

  async store(entry: MemoryEntry): Promise<void> {
    await this.client.upsert({
      collection: config.collection,
      data: entry
    });
  }

  retrieve(key: string): Promise<   {
    return await this.client.get(key);
  }
}
```

## 配置管理

### 插件配置

```typescript
// src/config/plugin-config.ts
interface PluginConfig {
  enabled: boolean;
  configPath: string;
  options: Record<string, any>;
}

// 加载插件配置
async function loadPluginConfig(pluginName: string): Promise<PluginConfig> {
  const configPath = path.join(
    '~/.openclaw/plugins',
    `${pluginName}.json`
  );

  const content = await fs.readFile(configPath, 'utf-8');
  return JSON.parse(content) as PluginConfig;
}
```

### 热更新

```typescript
// 监听配置变化
watchPluginConfig(pluginName: string, callback): void {
  const configPath = path.join(
    '~/.openclaw/plugins',
    `${pluginName}.json`
  );

  fs.watch(configPath, (event, filename) => {
    if (filename !== path.basename(configPath)) return;
    
    const newConfig = JSON.parse(fs.readFileSync(configPath, 'utf-8'));
    callback(newConfig);
  });
}
```

## 学习重点

1. **Plugin SDK**: 理解插件接口和元数据格式
2. **插件加载**: 学习插件发现和验证机制
3. **生命周期**: 掌握激活、停用流程
4. **渠道插件**: 学习如何实现自定义渠道
5. **内存插件**: 理解持久化接口

## 相关文件

- [src/plugin-sdk/](../../src/plugin-sdk/)
- [src/plugins/plugin-loader.ts](../../src/plugins/plugin-loader.ts)
- [src/plugins/plugin-validator.ts](../../src/plugins/plugin-validator.ts)
- [extensions/msteams/](../../extensions/msteams/)
- [src/plugins/memory/qdrant.ts](../../src/plugins/memory/qdrant.ts)

## 下一步

- [07-配置管理.md](./07-配置管理.md) - 配置系统
- [08-工具系统.md](./08-工具系统.md) - Tools实现

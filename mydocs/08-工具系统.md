# 08-工具系统

## 工具架构

```
Provider → Tool Registry → Gateway → Agent
```

## 工具接口

```typescript
// src/agents/tools/tool-registry.ts
interface Tool {
  name: string;
  description: string;
  parameters: ToolParameters;
  execute(params: any, context: ToolContext): Promise<ToolResult>;
}

interface ToolContext {
  sessionId: string;
  userId?: string;
  channel: string;
  permissions: string[];
}
```

## 工具注册

```typescript
// src/agents/tools/index.ts
class ToolRegistry {
  private tools = new Map<string, Tool>();

  register(tool: Tool): void {
    this.tools.set(tool.name, tool);
  }

  get(name: string): Tool | undefined {
    return this.tools.get(name);
  }

  list(filter?: ToolFilter): Tool[] {
    return Array.from(this.tools.values())
      .filter(tool => satisfiesFilter(tool))
      .sort((a, b) => a.name.localeCompare(b.name) < 0 ? 1 : -1);
  }

  hasPermission(
    toolName: string,
    permission: string
  ): boolean {
    const tool = this.get(toolName);
    return tool && tool.permissions?.includes(permission);
  }
}
```

## 内置工具

### 基础工具

```typescript
// bash命令执行
{
  name: 'bash',
  execute: async (params, context) => {
    const { command, directory, timeout } = params;
    return executeCommand(command, directory, timeout);
  }
}

// 文件操作
{
  name: 'read',
  execute: async (params, context) => {
    const { path } = params;
    return await fs.readFile(path, 'utf-8');
  }
}

{
  name: 'write',
  execute: async (params, context) => {
    const { path, content } = params;
    await fs.writeFile(path, content, 'utf-8');
  }
}

// 文件编辑
{
  name: 'edit',
  execute: async (params, context) => {
    const { path, edits } = params;
    return await editFile(path, edits);
  }
}
```

### OpenClaw工具

```typescript
// 浏览器控制
{
  name: 'browser',
  execute: async (params, context) => {
    const { action, url, options } = params;
    return await browserController.execute(action, url, options);
  }
}

// Canvas工具
{
  name: 'canvas',
  execute: async (params, context) => {
    const { action, data } = params;
    return await canvasHost.execute(action, data);
  }
}

// 节点工具
{
  name: 'nodes',
  execute: async (params, context) => {
    const { node, action, params: args } = params;
    return await nodeRegistry.invoke(node, action, args);
  }
}
```

### 会话工具

```typescript
{
  name: 'sessions_list',
  execute: async (params, context) => {
    return await sessionManager.list(params.filter);
  }
}

{
  name: 'sessions_send',
  execute: async (params, context) => {
    const { targetSessionId, message } = params;
    return await sessionManager.send(targetSessionId, message);
  }
}

{
  name: 'sessions_spawn',
  execute: async (params, context) => {
    const { config, mode } = params;
    const sessionId = await sessionManager.spawn(config, mode);
    return sessionId;
  }
}
```

### 渠道工具

```typescript
// Telegram特定工具
{
  name: 'telegram',
  execute: async (params, context) => {
    const { action } = params;
    return await telegramChannel.execute(action, context);
  }
}

// Slack特定工具
{
  name: 'slack',
  execute: async (params, context) => {
    const { channel, action } = params;
    return await slackChannel.execute(channel, action);
  }
}
```

## 工具权限

### 权限级别

```typescript
enum ToolPermission {
  AlwaysAllowed = 'always',
  MainOnly = 'main',
  NonMain = 'non-main',
  Blocked = 'blocked'
}

interface ToolConfig {
  name: string;
  permission: ToolPermission;
  sandboxMode?: 'off' | 'basic' | 'full';
}
```

### 权限检查流程

```typescript
async function checkToolPermission(
  toolName: string,
  sessionId: string
): Promise<PermissionResult> {
  const tool = toolRegistry.get(toolName);
  const session = sessionManager.get(sessionId);

  // 1. 检查工具是否存在
  if (!tool) {
    return { allowed: false, reason: 'Tool not found' };
  }

  // 2. 检查工具权限配置
  const permission = tool.permission;
  const allowed = checkPermission(tool.permission, session, tool);

  // 3. 特殊情况处理
  if (session.type === 'dm' && permission === 'main') {
    return { allowed: false, reason: 'DM sessions are not main' };
  }

  return { allowed, reason: '' };
}

function checkPermission(
  toolPermission: ToolPermission,
  session: Session,
  tool: Tool
): boolean {
  switch (toolPermission) {
    case 'always': return true;
    case 'main': return session.type === 'main';
    case 'non-main': return session.type !== 'main';
    case 'blocked': return false;
  default: return true;
  }
}
```

## 工具执行流程

```typescript
async function executeTool(
  toolName: string,
  params: any,
  context: ToolContext
): Promise<ToolResult> {
  // 1. 获取工具
  const tool = toolRegistry.get(toolName);
  if (!tool) {
    throw new ToolNotFoundError(toolName);
  }

  // 2. 权限检查
  const permissionCheck = await checkPermission(tool.name, context.sessionId, tool);
  if (!permissionCheck.allowed) {
    return {
      success: false,
      error: permissionCheck.reason || 'Permission denied',
      data: null
    };
  }

  // 3. 参数验证
  const validatedParams = validateToolParams(tool, params);
  if (validatedParams.errors) {
    return {
      success: false,
      error: 'Invalid parameters',
      errors: validatedParams.errors
    };
  }

  // 4. 执行
  try {
    const result = await tool.execute(params, context);
    return {
      success: true,
      data: result
    };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }

  // 5. 结果保存
  if (result.success) {
    await saveToolResult(context.sessionId, toolName, result.data);
  }
}
```

## 工具超时

```typescript
// src/agents/tools/timeout.ts
interface TimeoutConfig {
  default: number;
  toolSpecific: Record<string, number>;
}

const timeoutConfig: TimeoutConfig = {
  default: 30000,  // 30秒默认
  toolSpecific: {
    'bash': 120000,      // 2分钟
    'browser': 60000,     // 1分钟
    'browser.download': 300000, // 5分钟
    'canvas': 60000,        // 1分钟
    'canvas.eval': 300000,  // 1分钟
    'nodes': 60000           // 1分钟
    'node.camera': 30000,  // 1分钟
  }
};

async function executeWithTimeout<T>(
  fn: () => Promise<T>,
  timeoutMs: number
): Promise<T> {
  const result = await Promise.race([
    fn(),
    new Promise((_, resolve) =>
      setTimeout(() => resolve(null), timeoutMs)
  ]);
  return result;
}
```

## 学习重点

1. **工具注册**: 理解工具注册表和查找机制
2. **权限控制**: 掌握基于会话类型的权限检查
3. **执行流程**: 学习完整的工具调用流程
4. **超时控制**: 理解不同工具的超时配置

## 相关文件

- [src/agents/tools/index.ts](../../src/agents/tools/index.ts)
- [src/agents/tools/timeout.ts](../../src/agents/tools/timeout.ts)
- [src/agents/tools/bash/](../../src/agents/tools/bash/)
- [src/agents/tools/file/](../../src/agents/tools/file/)
- [src/agents/tools/canvas/](../../src/agents/tools/canvas/)
- [src/agents/tools/nodes/](../../src/agents/tools/nodes/)

## 下一步

- [09-会话管理.md](./09-会话管理.md) - Session模型